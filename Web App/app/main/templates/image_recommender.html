<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Recommendations</title>
    <!-- Include Bootstrap CSS and Select2 CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />
    <!-- Include custom CSS -->
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">

</head>
<body>
    <div class="container">
        <h1 class="text-center">Product Recommendations - Image</h1>
        <div class="row">
            <div class="col-md-4">
                <form id="recommendationForm" method="post" class="bg-white p-4 shadow rounded">
                    <div class="form-group">
                        <label for="product_title">Select Product Title:</label>
                        <select id="product_title" name="product_title" class="form-control" required>
                        {% for product_title in product_titles %}
                            <option value="{{ product_title }}">{{ product_title }}</option>
                        {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Get Recommendations</button>
                </form>
                <div id="selectedProductImage" class="mt-4"></div>
            </div>
            <div class="col-md-8">
                <div id="recommendations"></div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <!-- Include jQuery, Bootstrap JS, and Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let globalResponse = null; // To store the response globally

        $(document).ready(function() {
            $('#product_title').select2({
                placeholder: "Select a product",
                allowClear: true
            });

            $('#recommendationForm').on('submit', function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/image-recommend',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        globalResponse = response; // Store the response globally
                        displayRecommendations(response, 1);
                        setupPagination(response.recommendations.length);
                    }
                });
            });
        });

        function displayRecommendations(data, page) {
            // Display selected product image
            var selectedProductImageDiv = $('#selectedProductImage');
            selectedProductImageDiv.empty();
            selectedProductImageDiv.append('<h2>Selected Product Image</h2>');
            var selectedLoader = $('<div class="loader"></div>');
            selectedProductImageDiv.append(selectedLoader);
            if (data.selected_product_image) {
                var selectedImg = $('<img src="' + data.selected_product_image + '" alt="' + data.product_id + '">');
                selectedImg.on('load', function() {
                    selectedLoader.remove();
                    $(this).show();
                });
                selectedProductImageDiv.append(selectedImg);
            } else {
                selectedLoader.remove();
                selectedProductImageDiv.append('<p>No image available</p>');
            }

            var recommendationsDiv = $('#recommendations');
            recommendationsDiv.empty();
            recommendationsDiv.append('<h2>Recommendations for ' + data.product_title + '</h2>');
            var grid = $('<div class="recommendation-grid"></div>');
            var start = (page - 1) * 20;
            var end = start + 20;
            var recommendationsPage = data.recommendations.slice(start, end);
            recommendationsPage.forEach(function(rec) {
                var recommendationItem = $('<div class="recommendation-item"></div>');
                // recommendationItem.append('<p><strong>' + rec + '</strong></p>');
                var loader = $('<div class="loader"></div>');
                recommendationItem.append(loader);
                if (data.images[rec]) {
                    var img = $('<img src="' + data.images[rec] + '" alt="' + rec + '">');
                    img.on('load', function() {
                        loader.remove();
                        $(this).show();
                    });
                    recommendationItem.append(img);
                } else {
                    loader.remove();
                    recommendationItem.append('<p>No image available</p>');
                }
                grid.append(recommendationItem);
            });
            recommendationsDiv.append(grid);
        }

        function setupPagination(totalItems) {
            var paginationDiv = $('#pagination');
            paginationDiv.empty();
            var totalPages = Math.ceil(totalItems / 20);
            for (var i = 1; i <= totalPages; i++) {
                var button = $('<button>' + i + '</button>');
                button.on('click', function() {
                    var page = $(this).text();
                    displayRecommendations(globalResponse, page);
                    $('.pagination button').removeClass('disabled');
                    $(this).addClass('disabled');
                });
                paginationDiv.append(button);
            }
            paginationDiv.find('button').first().addClass('disabled'); // Disable the first button initially
        }
    </script>
</body>
</html>
